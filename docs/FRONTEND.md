# Frontend Specification

## Overview

Single-window Tauri app. React frontend calls 14 Tauri commands via typed bindings (`src/bindings.ts`, generated by tauri-specta on app startup in debug mode). No embedded terminal — Claude sessions open in the user's external terminal (tmux or iTerm2).

---

## Data Types (from backend)

```typescript
Repo {
  id: string
  name: string
  remote_url: string
  default_branch: string
  root_path: string           // e.g. ~/bunyan/repos/frontend
  remote: string
  display_order: number
  conductor_config: object | null  // { scripts: { setup?, run? }, runScriptMode? }
  created_at: string
  updated_at: string
}

Workspace {
  id: string
  repository_id: string
  directory_name: string      // e.g. "lisbon"
  branch: string
  state: "ready" | "archived"
  created_at: string
  updated_at: string
}

ClaudeSession {
  pid: number
  workspace_path: string
  workspace_id: string | null  // null = not a bunyan-managed workspace
  tty: string | null
}

Setting {
  key: string
  value: string
  created_at: string
  updated_at: string
}
```

## Backend Commands

| Command | Input | Output | Async |
|---------|-------|--------|-------|
| `list_repos` | — | `Repo[]` | no |
| `get_repo` | `id` | `Repo` | no |
| `create_repo` | `CreateRepoInput` | `Repo` | yes (git clone) |
| `update_repo` | `UpdateRepoInput` | `Repo` | no |
| `delete_repo` | `id` | `void` | no |
| `list_workspaces` | `repository_id?` | `Workspace[]` | no |
| `get_workspace` | `id` | `Workspace` | no |
| `create_workspace` | `CreateWorkspaceInput` | `Workspace` | yes (git worktree add) |
| `archive_workspace` | `id` | `Workspace` | yes (git worktree remove) |
| `get_setting` | `key` | `Setting` | no |
| `set_setting` | `key, value` | `Setting` | no |
| `get_all_settings` | — | `Setting[]` | no |
| `get_active_claude_sessions` | — | `ClaudeSession[]` | yes (pgrep + lsof) |
| `open_claude_session` | `workspace_id` | `"created" \| "focused" \| "running"` | yes |

### Path conventions

The frontend constructs `root_path` when creating a repo. The base directory is `~/bunyan/repos/<name>`. The frontend needs the user's home directory to build this path — use `@tauri-apps/api/path` (`homeDir()`) or store it as a setting on first launch.

Workspace paths are derived by the backend: `~/bunyan/workspaces/<repo_name>/<directory_name>`.

---

## Screens

The app has two screens, navigated without a router (simple conditional render based on app state):

1. **Main view** — repo list with nested workspaces
2. **Add repo view** — form to clone a new repo

Repo settings appear as an inline expandable panel within the main view, not a separate screen.

---

## Screen 1: Main View

### Layout

```
┌──────────────────────────────────────────────────────┐
│  Bunyan                     [Show archived] [+ Repo] │
├──────────────────────────────────────────────────────┤
│                                                      │
│  ▼ frontend                               [⚙]       │
│    ┌──────────────────────────────────────────────┐  │
│    │ lisbon       main        ● Claude  [Archive] │  │
│    │ cape-town    main          Claude  [Archive] │  │
│    └──────────────────────────────────────────────┘  │
│    [+ New Worktree]                                  │
│                                                      │
│  ▶ prismatic                              [⚙]       │
│                                                      │
│  ▶ backend                                [⚙]       │
│                                                      │
│                                                      │
│  ──────────────────────────────────────────────────  │
│  Other claude sessions: 2                            │
└──────────────────────────────────────────────────────┘
```

### Header Bar

- **Title**: "Bunyan" (left-aligned)
- **Show archived toggle**: Checkbox or toggle button. Default off. When on, archived workspaces appear in each repo's list with a visual distinction (muted text, strikethrough, or "archived" badge). Archived workspaces have no Claude button or Archive action.
- **+ Repo button**: Navigates to the Add Repo view.

### Repo Rows

Each repo is a collapsible section. Clicking the row header (or a chevron) toggles expansion.

**Collapsed state:**
- Chevron (▶), repo name, settings gear icon
- No workspace rows visible

**Expanded state:**
- Chevron (▼), repo name, settings gear icon
- Workspace rows listed below
- "+ New Worktree" button at the bottom of the workspace list

**Default**: All repos expanded on initial load.

**Settings gear (⚙)**: Clicking opens an inline settings panel below the repo header (pushes workspace rows down). See "Repo Settings Panel" below.

### Workspace Rows

Each row displays:

| Element | Description |
|---------|-------------|
| Directory name | e.g. "lisbon" |
| Branch name | e.g. "main" |
| Claude button | Click to open/focus session. Shows green dot (●) when a claude process is running at that workspace path, empty otherwise |
| Archive button | Archives the workspace (removes worktree on disk, marks as archived in DB) |

**Claude button behavior:**
1. User clicks Claude button
2. Call `open_claude_session(workspace_id)`
3. While the call is in flight, show a brief loading state on the button (spinner or pulse)
4. On response:
   - `"focused"` — session was already running, terminal was brought to focus. No UI change needed (dot was already green).
   - `"created"` — new terminal session launched. The dot will turn green on the next poll cycle.
   - `"running"` — session exists but couldn't focus the terminal (no tty match). Dot stays green. Optionally show a subtle toast: "Session running but couldn't focus terminal."

**Archive button behavior:**
1. User clicks Archive
2. Show confirmation dialog: "Archive <name>? This will remove the worktree from disk."
3. On confirm, call `archive_workspace(id)`
4. While in flight, show loading state on the row
5. On success, if "Show archived" is off, the row disappears. If on, it transitions to archived appearance.

### Workspace Row — Loading State

When `create_workspace` is in flight, the new workspace row appears immediately in the list with:
- Muted/disabled appearance
- Spinner replacing the Claude button
- No Archive button
- Once the command resolves, the row transitions to its normal active state

### Repo Settings Panel

Opens inline below the repo header when the gear icon is clicked. Contains:

**Fields:**
- **Setup script**: Text input. Maps to `conductor_config.scripts.setup`. Placeholder: "e.g. mise trust && make setup"
- **Run script**: Text input. Maps to `conductor_config.scripts.run`. Placeholder: "e.g. npm run dev"

**Actions:**
- **Save**: Calls `update_repo` with the updated `conductor_config` JSON. Button disabled when no changes.
- **Cancel**: Closes the panel, discards changes.
- **Delete repo**: Destructive action at the bottom. Shows confirmation dialog: "Delete <name>? This will remove the repo and all its workspaces from the database." On confirm, calls `delete_repo(id)`. The repo section disappears from the list.

**Behavior:**
- Only one repo settings panel can be open at a time. Opening a new one closes the previous.
- The panel pre-fills with existing values from `conductor_config`.

### "+ New Worktree" Flow

Clicking "+ New Worktree" under an expanded repo opens an inline form (replaces the button, or appears below it):

**Fields:**
- **Name**: Text input. Validated: no spaces allowed, non-empty. This becomes both `directory_name` and `branch`.
- **Base branch**: Dropdown/select defaulting to the repo's `default_branch`. Options should ideally come from the repo's branches, but for v1 this is a text input pre-filled with `default_branch`.

**Actions:**
- **Create**: Validates name (no spaces, non-empty, no duplicates among existing workspace names for this repo). Calls `create_workspace({ repository_id, directory_name: name, branch: name })`. The form closes and a loading-state workspace row appears.
- **Cancel**: Closes the form.

### Claude Session Polling

**Strategy: poll on interval + poll on window focus.**

- On app startup, call `get_active_claude_sessions()` immediately.
- Poll every 5 seconds while the window is visible.
- Poll immediately when the Tauri window gains focus (user switches back to the app).
- When the window is hidden/minimized, stop polling.

**Processing poll results:**
- The response is `ClaudeSession[]`. Each entry has `workspace_id: string | null`.
- Build a `Set<string>` of workspace IDs that have an active session.
- Workspace rows check this set to determine green dot vs empty.
- Count entries where `workspace_id === null` — display as "Other claude sessions: N" at the bottom of the main view. Only show this line when N > 0.

### "Other Claude Sessions" Footer

Displayed at the bottom of the main view when there are claude processes running outside of bunyan-managed workspaces.

```
Other claude sessions: 2
```

Static text for now. No click action. Visually subtle (smaller text, muted color).

---

## Screen 2: Add Repo View

### Layout

```
┌──────────────────────────────────────────────────────┐
│  ← Back                                             │
├──────────────────────────────────────────────────────┤
│                                                      │
│  Add Repository                                      │
│                                                      │
│  Remote URL                                          │
│  ┌──────────────────────────────────────────────┐    │
│  │ git@github.com:org/repo.git                  │    │
│  └──────────────────────────────────────────────┘    │
│                                                      │
│  Repository name (derived from URL)                  │
│  ┌──────────────────────────────────────────────┐    │
│  │ repo                                         │    │
│  └──────────────────────────────────────────────┘    │
│                                                      │
│                              [Cancel]  [Clone Repo]  │
│                                                      │
└──────────────────────────────────────────────────────┘
```

### Behavior

1. User types or pastes a git remote URL.
2. On URL change, auto-derive the repo name:
   - `git@github.com:org/frontend.git` → `frontend`
   - `https://github.com/org/frontend.git` → `frontend`
   - Extract the last path segment, strip `.git` suffix.
3. The name field is read-only (auto-derived). Displayed so the user can see what name will be used.
4. **Clone Repo** button:
   - Disabled when URL is empty.
   - On click: construct `root_path` as `~/bunyan/repos/<name>`. Call `create_repo({ name, remote_url, root_path, default_branch: "main", remote: "origin", display_order: 0, conductor_config: null })`.
   - Replace the form with a loading state: spinner + "Cloning <name>..." text. The Cancel and Clone buttons are hidden.
   - On success: navigate back to Main View. The new repo appears in the list.
   - On error: show the error message inline below the form. Restore the form to its editable state so the user can fix the URL and retry.
5. **Cancel** button: navigates back to Main View without doing anything.
6. **← Back** button in the header: same as Cancel.

---

## State Management

No external state management library. Use React state (`useState`, `useReducer`) and context where needed.

### App-level state

```typescript
{
  // Data
  repos: Repo[]
  workspaces: Workspace[]              // all workspaces across all repos
  activeSessions: Set<string>          // workspace IDs with running claude
  otherSessionCount: number            // claude processes not matched to bunyan workspaces

  // UI state
  currentView: "main" | "addRepo"
  expandedRepos: Set<string>           // repo IDs that are expanded
  openSettingsRepo: string | null      // repo ID whose settings panel is open
  showArchived: boolean
  newWorktreeRepo: string | null       // repo ID currently showing the new worktree form

  // Loading states
  cloningRepo: boolean
  creatingWorkspace: Set<string>       // repo IDs with a workspace creation in flight
  archivingWorkspace: Set<string>      // workspace IDs being archived
  openingSession: Set<string>          // workspace IDs with open_claude_session in flight
}
```

### Data loading

- On app mount: call `list_repos()` and `list_workspaces()` in parallel. Then call `get_active_claude_sessions()`.
- After `create_repo` succeeds: add the new repo to `repos`, navigate to main view.
- After `create_workspace` succeeds: add the new workspace to `workspaces`.
- After `archive_workspace` succeeds: update the workspace's state in `workspaces` to `"archived"`.
- After `delete_repo` succeeds: remove the repo from `repos` and its workspaces from `workspaces`.
- After `update_repo` succeeds: update the repo in `repos`.

### Polling lifecycle

```
App mounts
  → fetch repos + workspaces
  → fetch active sessions
  → start 5s interval polling for active sessions

Window focus event
  → fetch active sessions immediately

Window blur/hide event
  → (keep polling, the interval handles it — or optionally pause)

App unmounts
  → clear interval
```

---

## Error Handling

- Backend errors come back as thrown strings from the typed bindings.
- Display errors as inline messages near the action that triggered them (e.g. below the clone form, next to the archive button).
- No global toast/notification system for v1. Keep it simple.
- If `get_active_claude_sessions` fails (e.g. pgrep not found), fail silently — just show no green dots. Don't block the UI.

---

## Styling

No CSS framework decision locked in yet. Keep the initial implementation minimal:
- System font stack
- Simple flexbox layout
- Neutral color palette (grays, white background, dark text)
- Green dot for active sessions
- Muted/gray text for archived workspaces and disabled states
- Hover states on interactive elements (buttons, clickable rows)

---

## Keyboard Shortcuts

None for v1.

---

## Window Configuration

Current: 800x600, single window. This is likely sufficient for v1. The layout should be responsive within reasonable bounds (600-1200px width).
